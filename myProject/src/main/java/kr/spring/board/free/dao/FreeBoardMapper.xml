<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.spring.board.free.dao.FreeBoardMapper">

	<select id="selectRowCount" parameterType="map" resultType="integer">
		SELECT
			COUNT(*)
		FROM board_free b JOIN member m
		ON b.mem_num = m.mem_num
		<where>
			free_type = 0 
			<if test="keyword != '' and keyfield == 'title'">
				AND b.free_title LIKE '%' || #{keyword} || '%'
			</if>
			<if test="keyword != '' and keyfield == 'id'">
				AND m.id LIKE '%' || #{keyword} || '%'
			</if>
			<if test="keyword != '' and keyfield == 'content'">
				AND b.free_content LIKE '%' || #{keyword} || '%'
			</if>
			<if test="keyword != '' and keyfield == 'all'">
				AND b.free_title LIKE '%' || #{keyword} || '%' or
				m.id LIKE '%' || #{keyword} || '%' or
				b.free_content LIKE '%' || #{keyword} || '%'
			</if>
		</where>		
	</select>
	
	<select id="selectList" parameterType="map" resultType="freeBoardVO">	
		SELECT
			*
		FROM (SELECT
				a.*,
				rownum rnum
			  FROM (SELECT
			  			*
			  		FROM board_free b JOIN member m
			  		ON b.mem_num = m.mem_num
			  		<where>
			  			<if test="keyoword !='' and keyfield == 'title'">
			  				b.free_title LIKE '%' || #{keyword} || '%'
			  			</if>
			  			<if test="keyword != '' and keyfield == 'id'">
							m.id LIKE '%' || #{keyword} || '%'
						</if>
						<if test="keyword != '' and keyfield == 'content'">
							b.free_content LIKE '%' || #{keyword} || '%'
						</if>
						<if test="keyword != '' and keyfield == 'all'">
							b.free_title LIKE '%' || #{keyword} || '%' or
							m.id LIKE '%' || #{keyword} || '%' or
							b.free_content LIKE '%' || #{keyword} || '%'
						</if>
			  		</where>
			  		ORDER BY b.free_num DESC)a)
		<![CDATA[
			WHERE rnum >= #{start} AND rnum <= #{end} AND free_type = 0
		]]>	
	</select>
	
	<update id="updateBoardFree" parameterType="freeBoardVO">
		UPDATE 
			board_free
		SET 
			free_title = #{free_title},
			free_content = #{free_content},
			free_modify_date = SYSDATE,
			free_file = #{free_file},
			free_filename = #{free_filename},
			free_ip = #{free_ip}
		WHERE
			free_num = #{free_num}
	</update>
	
	<select id="selectFreeComment" parameterType="integer" resultType="FreeBoardCommentVO">
		SELECT * FROM board_free_comment c JOIN (
												SELECT m.*, CASE WHEN mem_auth = 1 then '일반회원'
	             												 WHEN mem_auth = 2 then '트레이너'
	            											     WHEN mem_auth = 0 then '관리자'
	               												 else '기타' END as mem_auth_s FROM member m
	               								)
	                USING(mem_num)
                WHERE free_num = #{free_num}
		 ORDER BY freec_num DESC
	</select>
	

</mapper>
